{% extends "chat/base.html" %}
{% load static %}
{% block content %}
{% load custom_filters %}
    <div class="chat-container">
        <div class="chat-header">
            <h1>{{ chat_user.username }}
                <i class="fas fa-comment"></i>
            </h1>
        </div>
        <div class="chat-leave">
            <div style="float: left; font-weight: bold; color: #036358">
                {{ user.username }}
            </div>
            <div style="float: right;">
                <a href="{% url 'index' %}">
                    <i class="fas fa-sign-out-alt"></i>
                    Leave Chat
                </a>
            </div>
            <div style="clear: both;"></div>
        </div>
        <div class="chat__message__container" id="chat__message__container">
            <textarea id="chat-log" cols="100" rows="20"></textarea><br>
        </div>
        <div class="chat-input-container">
            <input type="text" id="chat-message-input" placeholder="Type your message..." />
            <button type="submit" id="chat-message-submit"><i class="fas fa-paper-plane"></i> Send</button>
        </div>
    </div>
    {{ room_name|json_script:"room-name"}}
    <script>

        const roomName = JSON.parse(document.getElementById('room-name').textContent);
        console.log(roomName)

        const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/chat/'
            + roomName
            + '/'
        );

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            document.querySelector('#chat-log').value += (data.message + '\n');
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.key === 'Enter') {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };

        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInputDom.value = '';
        };

    </script>


{% endblock content %}

{#<!-- chat/templates/chat/room.html -->#}
{#<!DOCTYPE html>#}
{#<html>#}
{#<head>#}
{#    <meta charset="utf-8"/>#}
{#    <title>Chat Room</title>#}
{#</head>#}
{#<body>#}
{#    <textarea id="chat-log" cols="100" rows="20"></textarea><br>#}
{#    <input id="chat-message-input" type="text" size="100"><br>#}
{#    <input id="chat-message-submit" type="button" value="Send">#}
{#    {{ room_name|json_script:"room-name" }}#}
{#    <script>#}
{#        const roomName = JSON.parse(document.getElementById('room-name').textContent);#}
{#        console.log(roomName)#}
{##}
{#        const chatSocket = new WebSocket(#}
{#            'ws://'#}
{#            + window.location.host#}
{#            + '/ws/chat/'#}
{#            + roomName#}
{#            + '/'#}
{#        );#}
{##}
{#        chatSocket.onmessage = function(e) {#}
{#            const data = JSON.parse(e.data);#}
{#            document.querySelector('#chat-log').value += (data.message + '\n');#}
{#        };#}
{##}
{#        chatSocket.onclose = function(e) {#}
{#            console.error('Chat socket closed unexpectedly');#}
{#        };#}
{##}
{#        document.querySelector('#chat-message-input').focus();#}
{#        document.querySelector('#chat-message-input').onkeyup = function(e) {#}
{#            if (e.key === 'Enter') {  // enter, return#}
{#                document.querySelector('#chat-message-submit').click();#}
{#            }#}
{#        };#}
{##}
{#        document.querySelector('#chat-message-submit').onclick = function(e) {#}
{#            const messageInputDom = document.querySelector('#chat-message-input');#}
{#            const message = messageInputDom.value;#}
{#            chatSocket.send(JSON.stringify({#}
{#                'message': message#}
{#            }));#}
{#            messageInputDom.value = '';#}
{#        };#}
{#    </script>#}
{#</body>#}
{#</html>#}
